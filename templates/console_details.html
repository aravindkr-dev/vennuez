{% extends "base.html" %}

{% block title %}Console Details - Vennuez{% endblock %}



{% block content %}
<section class="console-details" style="padding: 2rem 0;">
    <div class="container" style="max-width: 900px;">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary mb-4"><i class="fas fa-arrow-left me-2"></i>Back to Dashboard</a>
        <div class="card" style="margin-bottom: 2rem;">
            <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 2rem;">
                <div style="flex: 2; min-width: 260px;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Console Information</h2>
                    <div style="margin-bottom: 0.5rem; color: var(--success); font-weight: 500;">
                        {% if console.is_available %}✔Available{% else %}Unavailable{% endif %}
                    </div>
                    <div style="margin-bottom: 0.5rem;"><i class="fas fa-gamepad"></i> {{ console.name }}</div>
                    <div style="margin-bottom: 0.5rem;"><strong>Type:</strong> {{ console.console_type }}</div>
                    <div style="margin-bottom: 0.5rem;"><i class="fas fa-rupee-sign"></i> Hourly Rate ₹{{ console.hourly_rate }}</div>
                    <div style="margin-bottom: 0.5rem;"><i class="fas fa-calendar-alt"></i> Added On {{ console.created_at.strftime('%d %B %Y') }}</div>
                </div>
                <div style="flex: 1; min-width: 220px;">
                    <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary);">Quick Stats</h3>
                    <div style="margin-bottom: 0.5rem;"><i class="fas fa-clock"></i> Total Slots: {{ slots|length }}</div>
                    <div style="margin-bottom: 0.5rem;"><i class="fas fa-check-circle" style="color: var(--success);"></i> Available: {{ slots|rejectattr('is_booked')|list|length }}</div>
                    <div style="margin-bottom: 0.5rem;"><i class="fas fa-lock" style="color: var(--danger);"></i> Booked: {{ slots|selectattr('is_booked')|list|length }}</div>
                    <div style="margin-bottom: 0.5rem;"><i class="fas fa-rupee-sign"></i> Revenue: ₹{{ "%.0f"|format(slots|selectattr('is_booked')|sum(attribute='total_amount') or 0) }}</div>
                    <div style="margin-bottom: 0.5rem;"><i class="fas fa-rupee-sign"></i> Advance: ₹{{ "%.0f"|format(slots|selectattr('is_booked')|sum(attribute='advance_paid') or 0) }}</div>
                    <div style="margin-bottom: 0.5rem;"><i class="fas fa-percent"></i> Booking Rate: {{ "%.1f"|format((slots|selectattr('is_booked')|list|length / slots|length * 100) if slots else 0) }}%</div>
                </div>
            </div>
        </div>

        <!-- Add Slot Buttons -->
        <div class="card mb-4">
            <div class="card-body d-flex justify-content-between align-items-center">
                <a href="{{ url_for('add_slot', console_id=console.id) }}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>Add Single Slot
                </a>
                <a href="{{ url_for('auto_slots', console_id=console.id) }}" class="btn btn-success">
                    <i class="fas fa-magic me-2"></i>Auto Generate Slots
                </a>
                <a href="{{ url_for('manage_pricing', console_id=console.id) }}" class="btn btn-warning">
                    <i class="fas fa-rupee-sign"></i> Manage Pricing
                </a>
            </div>
        </div>

        <div class="card" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                <h3 style="font-size: 1.2rem; font-weight: 600; margin: 0; color: var(--primary);"><i class="fas fa-clock"></i> Time Slots</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <form method="get" style="display: flex; gap: 0.5rem;">
                        <button type="submit" name="filter" value="all" class="btn btn-secondary" {% if filter == 'all' %}style="background: var(--accent); color: #fff;"{% endif %}>All</button>
                        <button type="submit" name="filter" value="available" class="btn btn-secondary" {% if filter == 'available' %}style="background: var(--accent); color: #fff;"{% endif %}>Available</button>
                        <button type="submit" name="filter" value="booked" class="btn btn-secondary" {% if filter == 'booked' %}style="background: var(--accent); color: #fff;"{% endif %}>Booked</button>
                    </form>
                </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                {% for slot in slots %}
                <div class="card" style="background: var(--muted); padding: 1rem; margin: 0;" data-slot-id="{{ slot.id }}" data-end-time="{{ slot.end_time.isoformat() }}">
                    <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 2rem; justify-content: space-between;">
                        <div style="flex: 2; min-width: 200px;">
                            <div style="margin-bottom: 0.3rem;"><i class="fas fa-calendar-alt"></i> {{ slot.start_time.strftime('%d %b %Y') }}</div>
                            <div style="margin-bottom: 0.3rem; color: var(--success);">{% if not slot.is_booked %}✔Available{% else %}Booked{% endif %}</div>
                            <div style="margin-bottom: 0.3rem;"><i class="fas fa-clock"></i> {{ slot.start_time.strftime('%I:%M %p') }} - {{ slot.end_time.strftime('%I:%M %p') }}</div>
                            <div style="margin-bottom: 0.3rem;"><i class="fas fa-hourglass-half"></i> {{ ((slot.end_time - slot.start_time).total_seconds() / 3600)|int }} hours</div>
                            <div style="margin-bottom: 0.3rem;"><i class="fas fa-rupee-sign"></i> Base Amount: ₹{{ slot.total_amount }}</div>
                            {% if slot.is_booked %}
                                <div style="margin-bottom: 0.3rem;"><i class="fas fa-users"></i> Number of People: {{ slot.number_of_people }}</div>
                                <div style="margin-bottom: 0.3rem;"><i class="fas fa-calculator"></i> Total: ₹{{ (console.hourly_rate * ((slot.end_time - slot.start_time).total_seconds() / 3600) * slot.number_of_people)|round(2) }}</div>
                                <div style="margin-bottom: 0.3rem;"><i class="fas fa-user"></i> Booked by: {{ slot.customer_name }}</div>
                                <div style="margin-bottom: 0.3rem;"><i class="fas fa-phone"></i> Phone: {{ slot.customer_phone }}</div>
                                <div style="margin-bottom: 0.3rem;"><i class="fas fa-envelope"></i> Email: {{ slot.customer_email }}</div>
                            {% endif %}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; min-width: 120px;">
                            {% if not slot.is_booked %}
                                <a href="{{ url_for('edit_slot', slot_id=slot.id) }}" class="btn btn-secondary" style="width: 100%;"><i class="fas fa-edit"></i> Edit</a>
                                <form method="post" action="{{ url_for('delete_slot', slot_id=slot.id) }}" style="margin: 0;" onsubmit="return confirm('Are you sure you want to delete this slot?');">
                                    <button type="submit" class="btn btn-secondary" style="width: 100%; background: var(--danger);"> <i class="fas fa-trash"></i> Delete</button>
                                </form>

                            {% endif %}
                            {% if slot.is_booked and not slot.completed %}
                                <button class="btn btn-warning" type="button" onclick="toggleCalculator({{ slot.id }})" id="calc_btn_{{ slot.id }}">Open Calculator</button>
                                <button class="btn btn-success" type="button" id="confirm_payment_btn_{{ slot.id }}" style="display:none; margin-top: 0.5rem;" onclick="submitCalculatorForm({{ slot.id }})">Confirm Payment</button>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Calculator Section for Booked Slots -->
                    {% if slot.is_booked and not slot.completed %}
                    <div class="calculator-section" id="calculator_{{ slot.id }}" style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; display: none;" data-base-amount="{{ slot.total_amount or 0 }}">
                        <h4 style="margin-bottom: 1rem; font-size: 1rem; color: #333;">Amount Calculator</h4>
                        <div style="margin-bottom: 0.5rem;"><strong>Booking Duration:</strong> {{ ((slot.end_time - slot.start_time).total_seconds() / 3600)|round(2) }} hours</div>
                        <form method="POST" action="{{ url_for('settle_slot', slot_id=slot.id) }}" class="calculator-form" id="calculator_form_{{ slot.id }}" onsubmit="return prepareSnacksData({{ slot.id }})">
                            <div id="snacks_list_{{ slot.id }}"></div>
                            <input type="hidden" name="snacks_amount" id="snacks_amount_{{ slot.id }}" value="0">
                            <input type="hidden" name="snacks_json" id="snacks_json_{{ slot.id }}">
                            <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                    <span>Base Amount:</span>
                                    <span>₹{{ slot.total_amount or 0 }}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                    <span>Snacks:</span>
                                    <span id="snacks_total_{{ slot.id }}">₹0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #dee2e6; padding-top: 0.3rem;">
                                    <span>Final Amount:</span>
                                    <span id="final_total_{{ slot.id }}">₹{{ slot.total_amount or 0 }}</span>
                                </div>
                            </div>
                            <input type="hidden" name="final_amount" id="final_amount_{{ slot.id }}" value="{{ slot.total_amount or 0 }}">
                            <button type="submit" class="btn btn-primary" style="width: 100%; display:none;" id="checkout_btn_{{ slot.id }}">Checkout</button>
                        </form>
                    </div>
                    {% endif %}

                    <!-- Payment Status for Completed Slots -->
                    {% if slot.completed %}
                    <div style="margin-top: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 8px;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 1rem; color: #2e7d32;">Payment Details</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span>Base Amount:</span>
                            <span>₹{{ slot.total_amount or 0 }}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span>Snacks Amount:</span>
                            <span>₹{{ slot.snacks_amount or 0 }}</span>
                            </div>
                        <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #2e7d32; padding-top: 0.3rem;">
                            <span>Total Paid:</span>
                            <span>₹{{ slot.final_amount or 0 }}</span>
                            </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div style="color: var(--secondary); font-size: 1.1rem;">No slots found.</div>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<script>
let snackMasterList = {};
fetch('/owner/snacks/json').then(r => r.json()).then(data => {
    snackMasterList = {};
    data.forEach(function(snack) { snackMasterList[snack.name] = snack.rate; });
    // Render snacks for all open calculators
    {% for slot in slots %}
    if (document.getElementById('calculator_{{ slot.id }}')) {
        renderAllSnacks({{ slot.id }});
    }
    {% endfor %}
});
function renderAllSnacks(slotId) {
    const snacks = window[`snacks_${slotId}`] || [];
    let html = '<table class="table"><thead><tr><th>Name</th><th>Rate</th><th>Qty</th><th>Total</th></tr></thead><tbody>';
    let snacksTotal = 0;
    Object.keys(snackMasterList).forEach(function(name) {
        const rate = snackMasterList[name];
        let qty = 0;
        const existing = snacks.find(function(s) { return s.name === name; });
        if (existing) qty = existing.qty;
        const total = rate * qty;
        snacksTotal += total;
        // Use single quotes inside the onchange attribute and escape any single quotes in the name
        const safeName = name.replace(/'/g, "\\'");
        html += `<tr><td>${name}</td><td>₹${rate}</td><td><input type=\"number\" min=\"0\" value=\"${qty}\" style=\"width:100px; font-size:1.2em; padding:0.4em;\" onchange=\"setSnackQty(${slotId},'${safeName}',this.value)\"></td><td>₹${total.toFixed(2)}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById(`snacks_list_${slotId}`).innerHTML = html;
    document.getElementById(`snacks_total_${slotId}`).textContent = `₹${snacksTotal.toFixed(2)}`;
    document.getElementById(`snacks_amount_${slotId}`).value = snacksTotal.toFixed(2);
    // Update final amount
    const calcSection = document.getElementById(`calculator_${slotId}`);
    const base = parseFloat(calcSection.getAttribute('data-base-amount')) || 0;
    const final = base + snacksTotal;
    document.getElementById(`final_total_${slotId}`).textContent = `₹${final.toFixed(2)}`;
    document.getElementById(`final_amount_${slotId}`).value = final.toFixed(2);
    // Save snacks array
    window[`snacks_${slotId}`] = Object.keys(snackMasterList).map(function(name) {
        const rate = snackMasterList[name];
        const qty = parseInt(document.querySelector(`#snacks_list_${slotId} input[type=number][onchange*='${name.replace(/'/g, "\\'") }']`).value) || 0;
        return { name: name, rate: rate, qty: qty };
    }).filter(s => s.qty > 0);
}
function setSnackQty(slotId, name, qty) {
    let snacks = window[`snacks_${slotId}`] || [];
    qty = parseInt(qty) || 0;
    const idx = snacks.findIndex(function(s) { return s.name === name; });
    if (idx >= 0) {
        snacks[idx].qty = qty;
    } else if (qty > 0) {
        snacks.push({ name: name, rate: snackMasterList[name], qty: qty });
    }
    window[`snacks_${slotId}`] = snacks;
    renderAllSnacks(slotId);
}
function prepareSnacksData(slotId) {
    const snacks = window[`snacks_${slotId}`] || [];
    document.getElementById(`snacks_json_${slotId}`).value = JSON.stringify(snacks);
    return true;
}
function toggleCalculator(slotId) {
    const calc = document.getElementById(`calculator_${slotId}`);
    if (calc.style.display === 'none') {
        calc.style.display = 'block';
    } else {
        calc.style.display = 'none';
                }
}
function submitCalculatorForm(slotId) {
    const form = document.getElementById(`calculator_form_${slotId}`);
    if (form) {
        form.submit();
    }
}
function checkConfirmPaymentTime() {
    const now = new Date();
    document.querySelectorAll('[data-end-time]').forEach(slot => {
        const endTime = new Date(slot.dataset.endTime);
        const tenMinutesBefore = new Date(endTime.getTime() - 10 * 60000); // 10 minutes before
        const confirmBtn = document.getElementById(`confirm_payment_btn_${slot.dataset.slotId}`);
        if (confirmBtn && now >= tenMinutesBefore) {
            confirmBtn.style.display = 'block';
            confirmBtn.disabled = false;
            confirmBtn.title = 'Confirm payment received';
        } else if (confirmBtn) {
            confirmBtn.style.display = 'none';
            confirmBtn.disabled = true;
            confirmBtn.title = 'Confirmation will be available 10 minutes before slot ends';
        }
    });
}
// Check immediately and then every minute
checkConfirmPaymentTime();
setInterval(checkConfirmPaymentTime, 60000);
</script>
{% endblock %}
